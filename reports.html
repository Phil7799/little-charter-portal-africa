<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Charter & HR Analytics</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <div class="logo">
                    <span class="logo-blue">L</span>
                    <span class="logo-green">I</span>
                    <span class="logo-yellow">T</span>
                    <span class="logo-red">T</span>
                    <span class="logo-blue">L</span>
                    <span class="logo-green">E</span>
                    <span class="logo-yellow"> </span>
                    <span class="logo-red">A</span>
                    <span class="logo-blue">F</span>
                    <span class="logo-green">R</span>
                    <span class="logo-yellow">I</span>
                    <span class="logo-red">C</span>
                    <span class="logo-blue">A</span>
                </div>
                <h1>Reports</h1>
            </div>
            <div class="portal-toggle">
                <button id="switchPortal" class="toggle-btn">
                    <i class="fas fa-exchange-alt"></i> Switch to Sales Portal
                </button>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav class="navbar">
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i> Overview</a></li>
                <li><a href="upload.html"><i class="fas fa-upload"></i> Upload Data</a></li>
                <li><a href="dashboard.html"><i class="fas fa-chart-bar"></i> Analytics Dashboard</a></li>
                <li><a href="team-performance.html"><i class="fas fa-users"></i> Team Performance</a></li>
                <li><a href="reports.html" class="active"><i class="fas fa-file-alt"></i> Reports</a></li>
            </ul>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="welcome-section">
                <h2><i class="fas fa-file-alt blue-text"></i> Reports & Export</h2>
                <p>Generate and download comprehensive reports for your Charter and HR services data.</p>
            </div>
            
            <!-- Report Generation Options -->
            <div class="action-cards">
                <div class="action-card">
                    <div class="action-icon blue">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3>Export to Excel</h3>
                    <p>Download complete data in Excel format with all sheets and calculations.</p>
                    <button id="exportExcel" class="btn">
                        <i class="fas fa-download"></i> Export Excel
                    </button>
                </div>
                
                <div class="action-card">
                    <div class="action-icon green">
                        <i class="fas fa-file-csv"></i>
                    </div>
                    <h3>Export to CSV</h3>
                    <p>Download data as CSV files for charter and HR services separately.</p>
                    <button id="exportCSV" class="btn">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
                
                <div class="action-card">
                    <div class="action-icon yellow">
                        <i class="fas fa-print"></i>
                    </div>
                    <h3>Print Report</h3>
                    <p>Generate a printable summary report of all key metrics and charts.</p>
                    <button id="printReport" class="btn">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                </div>
            </div>
            
            <!-- Summary Report Preview -->
            <div class="data-table-container">
                <h3><i class="fas fa-chart-bar blue-text"></i> Summary Report Preview</h3>
                
                <div style="margin: 20px 0;">
                    <h4>Charter Services Summary - 2026</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Target</th>
                                <th>Achievement %</th>
                            </tr>
                        </thead>
                        <tbody id="charterSummary">
                            <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>HR Services Summary - 2026</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Target</th>
                                <th>Achievement %</th>
                            </tr>
                        </thead>
                        <tbody id="hrSummary">
                            <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Monthly Performance Summary - 2026</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Charter Revenue</th>
                                <th>HR Revenue</th>
                                <th>Total Revenue</th>
                                <th>Total Target</th>
                                <th>Achievement %</th>
                            </tr>
                        </thead>
                        <tbody id="monthlySummary">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Associate Performance Summary - 2026</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Associate</th>
                                <th>2025 Revenue</th>
                                <th>2026 Revenue</th>
                                <th>Target</th>
                                <th>Achievement %</th>
                                <th>YoY Growth %</th>
                            </tr>
                        </thead>
                        <tbody id="associateSummary">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Report Settings -->
            <div class="welcome-section">
                <h3><i class="fas fa-cog blue-text"></i> Report Settings</h3>
                <div class="filters">
                    <div class="filter-group">
                        <label for="reportYear"><i class="fas fa-calendar"></i> Report Year</label>
                        <select id="reportYear">
                            <option value="2026">2026</option>
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="reportFormat"><i class="fas fa-file"></i> Format</label>
                        <select id="reportFormat">
                            <option value="detailed">Detailed</option>
                            <option value="summary">Summary Only</option>
                            <option value="executive">Executive Summary</option>
                        </select>
                    </div>
                    <button id="refreshReport" class="btn">
                        <i class="fas fa-sync"></i> Refresh Report
                    </button>
                </div>
            </div>
            
        </main>
        
        <!-- Footer -->
        <footer class="footer">
            <p>Little Africa Charter & HR Analytics Portal &copy; 2025</p>
            <p>Reports generated from current data. Last updated: <span id="lastUpdate">Never</span></p>
        </footer>
    </div>
    
    <script src="data-parser.js"></script>
    <script src="script.js"></script>
    <script>
        // Reports specific initialization
        document.addEventListener('DOMContentLoaded', function() {
            const hasData = dataParser.loadFromLocalStorage();
            if (hasData) {
                updateReports();
            }
            
            // Update last update time
            const lastUpdate = localStorage.getItem('lastDataUpdate');
            if (lastUpdate) {
                const updateDate = new Date(lastUpdate);
                document.getElementById('lastUpdate').textContent = 
                    updateDate.toLocaleDateString() + ' ' + updateDate.toLocaleTimeString();
            }
            
            // Export buttons
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('exportCSV').addEventListener('click', exportToCSV);
            document.getElementById('printReport').addEventListener('click', printReport);
            document.getElementById('refreshReport').addEventListener('click', updateReports);
        });
        
        function updateReports() {
            const data = dataParser.processedData;
            if (!data) return;
            
            // Update Charter Summary
            const charterSummary = document.getElementById('charterSummary');
            charterSummary.innerHTML = `
                <tr>
                    <td>Total Revenue 2026</td>
                    <td>Ksh ${dataParser.formatNumber(data.charter.totals?.total2026 || 0)}</td>
                    <td>Ksh ${dataParser.formatNumber(data.charter.totals?.target2026 || 0)}</td>
                    <td class="${(data.summary.charter?.achievement || 0) >= 100 ? 'positive' : 'negative'}">${(data.summary.charter?.achievement || 0).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Total Revenue 2025</td>
                    <td>Ksh ${dataParser.formatNumber(data.charter.totals?.total2025 || 0)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Year-over-Year Growth</td>
                    <td colspan="2" class="${(data.summary.charter?.yoy || 0) >= 0 ? 'positive' : 'negative'}">${(data.summary.charter?.yoy || 0).toFixed(1)}%</td>
                    <td>-</td>
                </tr>
            `;
            
            // Update HR Summary
            const hrSummary = document.getElementById('hrSummary');
            hrSummary.innerHTML = `
                <tr>
                    <td>Total Revenue 2026</td>
                    <td>Ksh ${dataParser.formatNumber(data.hr.totals?.total2026 || 0)}</td>
                    <td>Ksh ${dataParser.formatNumber(data.hr.totals?.target2026 || 0)}</td>
                    <td class="${(data.summary.hr?.achievement || 0) >= 100 ? 'positive' : 'negative'}">${(data.summary.hr?.achievement || 0).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>Total Revenue 2025</td>
                    <td>Ksh ${dataParser.formatNumber(data.hr.totals?.total2025 || 0)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
                <tr>
                    <td>Total Revenue 2024</td>
                    <td>Ksh ${dataParser.formatNumber(data.hr.totals?.total2024 || 0)}</td>
                    <td>-</td>
                    <td>-</td>
                </tr>
            `;
            
            // Update Monthly Summary
            const monthlySummary = document.getElementById('monthlySummary');
            const months = data.summary?.months || [];
            monthlySummary.innerHTML = '';
            
            months.forEach(month => {
                const charterMonth = data.charter.byMonth?.[month] || { total2026: 0, target2026: 0 };
                const hrMonth = data.hr.byMonth?.[month] || { total2026: 0, target2026: 0 };
                const totalRevenue = charterMonth.total2026 + hrMonth.total2026;
                const totalTarget = charterMonth.target2026 + (hrMonth.target2026 || 0);
                const achievement = totalTarget > 0 ? (totalRevenue / totalTarget) * 100 : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${month}</td>
                    <td>Ksh ${dataParser.formatNumber(charterMonth.total2026)}</td>
                    <td>Ksh ${dataParser.formatNumber(hrMonth.total2026)}</td>
                    <td>Ksh ${dataParser.formatNumber(totalRevenue)}</td>
                    <td>Ksh ${dataParser.formatNumber(totalTarget)}</td>
                    <td class="${achievement >= 100 ? 'positive' : 'negative'}">${achievement.toFixed(1)}%</td>
                `;
                monthlySummary.appendChild(row);
            });
            
            // Update Associate Summary
            const associateSummary = document.getElementById('associateSummary');
            const associates = Object.keys(data.charter.byAssociate || {});
            associateSummary.innerHTML = '';
            
            associates.forEach(associate => {
                const assocData = data.charter.byAssociate[associate];
                const achievement = assocData.target2026 > 0 ? (assocData.total2026 / assocData.target2026) * 100 : 0;
                const yoy = assocData.total2025 > 0 ? ((assocData.total2026 - assocData.total2025) / assocData.total2025) * 100 : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${associate.split('@')[0]}</td>
                    <td>Ksh ${dataParser.formatNumber(assocData.total2025)}</td>
                    <td>Ksh ${dataParser.formatNumber(assocData.total2026)}</td>
                    <td>Ksh ${dataParser.formatNumber(assocData.target2026)}</td>
                    <td class="${achievement >= 100 ? 'positive' : 'negative'}">${achievement.toFixed(1)}%</td>
                    <td class="${yoy >= 0 ? 'positive' : 'negative'}">${yoy.toFixed(1)}%</td>
                `;
                associateSummary.appendChild(row);
            });
        }
        
        function exportToExcel() {
            const data = dataParser.processedData;
            if (!data) {
                alert('No data available to export');
                return;
            }
            
            const workbook = XLSX.utils.book_new();
            
            // Charter Summary Sheet
            const charterData = [
                ['Charter Services Summary - 2026'],
                ['Metric', 'Value', 'Target', 'Achievement %'],
                ['Total Revenue 2026', data.charter.totals?.total2026 || 0, data.charter.totals?.target2026 || 0, (data.summary.charter?.achievement || 0).toFixed(2)],
                ['Total Revenue 2025', data.charter.totals?.total2025 || 0, '', ''],
                ['YoY Growth %', (data.summary.charter?.yoy || 0).toFixed(2), '', '']
            ];
            
            const charterSheet = XLSX.utils.aoa_to_sheet(charterData);
            XLSX.utils.book_append_sheet(workbook, charterSheet, 'Charter Summary');
            
            // HR Summary Sheet
            const hrData = [
                ['HR Services Summary - 2026'],
                ['Metric', 'Value', 'Target', 'Achievement %'],
                ['Total Revenue 2026', data.hr.totals?.total2026 || 0, data.hr.totals?.target2026 || 0, (data.summary.hr?.achievement || 0).toFixed(2)],
                ['Total Revenue 2025', data.hr.totals?.total2025 || 0, '', ''],
                ['Total Revenue 2024', data.hr.totals?.total2024 || 0, '', '']
            ];
            
            const hrSheet = XLSX.utils.aoa_to_sheet(hrData);
            XLSX.utils.book_append_sheet(workbook, hrSheet, 'HR Summary');
            
            // Monthly Detail Sheet
            const monthlyHeader = ['Month', 'Charter Revenue', 'HR Revenue', 'Total Revenue', 'Total Target', 'Achievement %'];
            const monthlyData = [monthlyHeader];
            
            const months = data.summary?.months || [];
            months.forEach(month => {
                const charterMonth = data.charter.byMonth?.[month] || { total2026: 0, target2026: 0 };
                const hrMonth = data.hr.byMonth?.[month] || { total2026: 0, target2026: 0 };
                const totalRevenue = charterMonth.total2026 + hrMonth.total2026;
                const totalTarget = charterMonth.target2026 + (hrMonth.target2026 || 0);
                const achievement = totalTarget > 0 ? (totalRevenue / totalTarget) * 100 : 0;
                
                monthlyData.push([
                    month,
                    charterMonth.total2026,
                    hrMonth.total2026,
                    totalRevenue,
                    totalTarget,
                    achievement.toFixed(2)
                ]);
            });
            
            const monthlySheet = XLSX.utils.aoa_to_sheet(monthlyData);
            XLSX.utils.book_append_sheet(workbook, monthlySheet, 'Monthly Details');
            
            // Generate and download
            XLSX.writeFile(workbook, 'Charter_HR_Report_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }
        
        function exportToCSV() {
            const data = dataParser.processedData;
            if (!data) {
                alert('No data available to export');
                return;
            }
            
            // Charter CSV
            let charterCSV = 'Month,Associate,Revenue 2025,Revenue 2026,Target 2026\n';
            const months = data.summary?.months || [];
            const associates = Object.keys(data.charter.byAssociate || {});
            
            months.forEach(month => {
                associates.forEach(associate => {
                    const monthData = data.charter.byAssociate[associate]?.months?.[month];
                    if (monthData) {
                        charterCSV += `${month},${associate},${monthData.total2025},${monthData.total2026},${monthData.target2026}\n`;
                    }
                });
            });
            
            downloadCSV(charterCSV, 'charter_data.csv');
            
            // HR CSV
            let hrCSV = 'Month,Revenue 2024,Revenue 2025,Revenue 2026,Target 2026\n';
            months.forEach(month => {
                const monthData = data.hr.byMonth?.[month];
                if (monthData) {
                    hrCSV += `${month},${monthData.total2024 || 0},${monthData.total2025 || 0},${monthData.total2026 || 0},${monthData.target2026 || 0}\n`;
                }
            });
            
            downloadCSV(hrCSV, 'hr_data.csv');
        }
        
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function printReport() {
            window.print();
        }
    </script>
    
    <style>
        @media print {
            .header, .navbar, .footer, .action-cards, .welcome-section h3, button {
                display: none;
            }
            
            .data-table-container {
                page-break-inside: avoid;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            th, td {
                border: 1px solid #000;
                padding: 8px;
            }
        }
    </style>
</body>
</html>